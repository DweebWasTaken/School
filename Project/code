import quiz
import random
import os
import json
import password_encrypt

import hashlib

def encrypt(password):
    return hashlib.sha256(password.encode('utf-8')).hexdigest()

def decrypt(password):
    return password_encrypt.decrypt(password)    


#Ensure that userid is unique and password complies with the following.
#Should have at least one number.
#Should have at least one uppercase and one lowercase character.
#Should have at least one of these special symbols (!@#$%).
#Should be between 4 to 20 characters long.
#Password stored in encrypted form.
#Password is encrypted using the password_encrypt.py module.
#Password is decrypted using the password_encrypt.py module.
def register():
    print("Please enter a username: ")
    username = input()
    if check_username(username) == False:
        print("Username already exists")
        return register()
    else:
        print("Please enter a password: ")
        password = input()
        if len(password) < 4 or len(password) > 20:
            print("Password should be between 4 to 20 characters long")
            return register()
        elif not any(char.isdigit() for char in password):
            print("Password should have at least one number")
            return register()
        elif not any(char.islower() for char in password):
            print("Password should have at least one lowercase character")
            return register()
        elif not any(char.isupper() for char in password):
            print("Password should have at least one uppercase character")
            return register()
        elif not any(char in '!@#$%' for char in password):
            print("Password should have at least one of these special symbols (!@#$%)")
            return register()
        else:
            #encrypt password
            password = encrypt(password)
            #add password and username to file
            with open("userid_pswd.txt","a") as file:
                file.write(username + " " + password + "\n")
            print("You have been successfully registered")
            return login()

#first let's check if username is already taken
def check_username(username):
    for line in open("userid_pswd.txt","r").readlines(): # Read the lines
        login_info = line.split() # Split on the space, and store the results in a list of two strings
        if username == login_info[0]:
            return False
    return True




#Username called "Admin"  which can Add/Delete/Edit the items in quiz settings text file. & also Add/Delete/Edit the questions in quiz questions text file.
def admin_login():
    print("Please select an option ")
    print("1. Add Question")
    print("2. Delete Question")
    print("3. Edit Question")
    print("4. Add Quiz Settings")
    print("5. Delete Quiz Settings")
    print("6. Edit Quiz Settings")
    print("7. Exit")
    # Get user input
    choice = input("Enter your choice: ")
    if choice == "1":
        add_question()
    elif choice == "2":
        delete_question()
    elif choice == "3":
        edit_question()
    elif choice == "4":
        add_quiz_settings()
    elif choice == "5":
        delete_quiz_settings()
    elif choice == "6":
        edit_quiz_settings()
    elif choice == "7":
        return False
    else:
        print("Invalid choice, please try again... ")
        return admin_login()

def add_question():
    print("Please enter the question: ")
    question = input()
    if question in quiz.questions:
        print("Question already exists")
        return admin_login()
    else:
        print("Please enter the answer: ")
        answer = input()
        quiz.questions[question] = answer
        print("Question added successfully")
        return admin_login()
def delete_question():
    print("Please enter the question: ")
    question = input()
    if question in quiz.questions:
        del quiz.questions[question]
        print("Question deleted successfully")
        return admin_login()
    else:
        print("Question not found")
        return admin_login()


def edit_question():
    print("Please enter the question: ")
    question = input()
    if question in quiz.questions:
        print("Please enter the new question: ")
        new_question = input()
        print("Please enter the new answer: ")
        new_answer = input()
        quiz.questions[new_question] = new_answer
        print("Question edited successfully")
        return admin_login()
    else:
        print("Question not found")
        return admin_login()

def edit_quiz_settings():
    print("Please enter the quiz settings: ")
    quiz_settings = input()
    if quiz_settings in quiz.quiz_settings:
        print("Please enter the new quiz settings: ")
        new_quiz_settings = input()
        quiz.quiz_settings[new_quiz_settings] = quiz.quiz_settings[quiz_settings]
        del quiz.quiz_settings[quiz_settings]
        print("Quiz settings edited successfully")
        return admin_login()
    else:
        print("Quiz settings not found")
        return admin_login()

def add_quiz_settings():
    print("Please enter the quiz settings: ")
    quiz_settings = input()
    if quiz_settings in quiz.quiz_settings:
        print("Quiz settings already exists")
        return admin_login()
    else:
        print("Please enter the number of questions: ")
        num_questions = input()
        print("Please enter the number of options: ")
        num_options = input()
        quiz.quiz_settings[quiz_settings] = [num_questions, num_options]
        print("Quiz settings added successfully")
        return admin_login()

def delete_quiz_settings():
    print("Please enter the quiz settings: ")
    quiz_settings = input()
    if quiz_settings in quiz.quiz_settings:
        del quiz.quiz_settings[quiz_settings]
        print("Quiz settings deleted successfully")
        return admin_login()
    else:
        print("Quiz settings not found")
        return admin_login()     

       

# Login function
def login():
    print("Please enter your username: ")
    username = input()
    print("Please enter your password: ")
    password = input()
    if check_password(username, password) == False:
        print("Invalid username or password")
        return login()
    else:
        print("You have successfully logged in")
        return quiz_menu()


#Recover forgotten password & changes password for accounts that have been created
def recover_password():
    print("Please enter your username: ")
    username = input()
    for line in open("userid_pswd.txt","r").readlines(): # Read the lines
        login_info = line.split() # Split on the space, and store the results in a list of two strings
        if username == login_info[0]:
            print("Please enter your new password: ")
            password = input()
            print("Please re-enter your new password: ")
            password_check = input()
            if password != password_check:
                print("Passwords do not match")
                return recover_password()
            else:
                file = open("userid_pswd.txt", "r")
                lines = file.readlines()
                file.close()
                file = open("userid_pswd.txt", "w")
                for line in lines:
                    if username in line:
                        file.write(username + " " + password)
                    else:
                        file.write(line)
                file.close()
                print("Password changed successfully")
                return menu()
    print("Username not found")
    return recover_password()


#quiz game
def quiz_game():
    print("Welcome to the quiz game")
    print("Please select an option ")
    print("1. Start Quiz")
    print("2. Exit")
    # Get user input
    choice = input("Enter your choice: ")
    if choice == "1":
        return quiz_game_start()
    elif choice == "2":
        return False
    else:
        print("Invalid choice, please try again... ")
        return quiz_game()

#quiz game start function , questions are randomly selected from the quiz questions text file

    



#print menu options
def menu():
    print("Please select an option ")
    print("1. Login")
    print("2. Register")
    print("3. Recover Password")
    print("4. Exit")
    # Get user input
    choice = input("Enter your choice: ")
    if choice == "1":
        return login()
    elif choice == "2":
        return register()
    elif choice == "3":
        return recover_password()
    elif choice == "4":
        return False
    else:
        print("Invalid choice, please try again... ")
        return menu()



menu()        
